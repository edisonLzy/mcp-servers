# Daily Note Summary Workflow

## 概述
根据当前零散的知识生成结构化的飞书文档，从Daily Note多维表格中提取当日记录并创建美观的汇总文档。

## 输入参数
- `target_date` (可选): 目标日期，格式为 YYYY-MM-DD，如不提供则使用当前日期

## 执行步骤

### 1. 搜索Daily Note多维表格
使用 `search-wiki` 工具搜索标题为 "Daily Note" 的多维表格：
```
工具: search-wiki
参数: {
  "query": "Daily Note"
}
```

从搜索结果中找到 `obj_type` 为 "bitable" 且 `title` 为 "Daily Note" 的项目，获取其 `obj_token` 作为 `app_token`。

**错误处理：**
- 如果搜索结果为空：停止执行，告知用户"未找到名为'Daily Note'的多维表格，请确认表格名称是否正确或您是否有访问权限"
- 如果找到多个同名表格：列出所有匹配项，要求用户确认选择哪一个
- 如果找不到bitable类型的项目：告知用户"找到名为'Daily Note'的项目，但不是多维表格类型，当前找到的类型为：[列出找到的类型]"

**用户决策点：** 是否继续？如果表格名称不对，用户可以提供正确的表格名称重新搜索。

### 2. 获取多维表格结构
使用 `list-bitable-tables` 工具获取表格列表：
```
工具: list-bitable-tables
参数: {
  "app_token": "[从步骤1获取的app_token]"
}
```

选择主表格（通常是第一个表格）获取 `table_id`。

**错误处理：**
- 如果API调用失败：停止执行，告知用户"无法访问多维表格，错误信息：[具体错误]，请检查权限或稍后重试"
- 如果表格列表为空：停止执行，告知用户"多维表格中没有找到数据表，请确认表格结构是否正确"
- 如果有多个表格：列出所有表格名称，要求用户确认使用哪个表格

**用户决策点：** 选择正确的数据表，或确认是否有访问权限。

### 3. 获取表格字段信息
使用 `list-bitable-fields` 工具了解字段结构：
```
工具: list-bitable-fields
参数: {
  "app_token": "[app_token]",
  "table_id": "[table_id]"
}
```

识别关键字段：
- 日期字段（可能名为"日期"、"Date"、"创建时间"等）
- 标题字段（可能名为"标题"、"Title"等）
- 内容字段（可能名为"内容"、"Content"、"描述"等）
- 分类字段（可能名为"分类"、"Category"、"类型"等）
- 标签字段（可能名为"标签"、"Tags"等）

**错误处理：**
- 如果无法获取字段信息：停止执行，告知用户"无法读取表格字段结构，错误信息：[具体错误]"
- 如果找不到日期相关字段：告知用户"未找到日期字段，请确认表格中是否有日期、Date或创建时间等字段。当前可用字段：[列出所有字段]"
- 如果字段结构不符合预期：列出所有字段，让用户确认哪些字段对应标题、内容、分类等

**用户决策点：** 确认字段映射关系，或修改表格结构以包含必要字段。

### 4. 查询当日记录
使用 `get-bitable-records` 工具获取指定日期的记录：
```
工具: get-bitable-records
参数: {
  "app_token": "[app_token]",
  "table_id": "[table_id]",
  "filter_field": "[日期字段名]",
  "filter_operator": "is",
  "filter_value": "{{target_date}}",
  "sort_field": "[日期字段名]",
  "sort_desc": true,
  "page_size": 100,
  "include_automatic_fields": true
}
```

**错误处理：**
- 如果查询失败：停止执行，告知用户"查询记录失败，错误信息：[具体错误]，可能原因：字段名不正确、日期格式不匹配或权限不足"
- 如果日期格式错误：告知用户"日期格式可能不匹配，请确认表格中日期字段的格式，当前使用格式：{{target_date}}"
- 如果查询返回空结果：继续执行但标注"当日无记录"，询问用户是否仍要创建空文档

**用户决策点：**
- 确认日期格式和字段名是否正确
- 如果当日无记录，决定是否继续创建空文档还是终止流程

### 5. 生成结构化Markdown文档

根据获取的记录生成以下格式的Markdown内容：

```markdown
# Daily Summary - {{target_date}}

## 概览
- 总条目数: [记录数量]
- 生成时间: [当前时间戳]

## 内容分类

### [分类名称1]
#### [条目标题1]
[条目内容]

**标签:** [标签列表]
**创建时间:** [记录创建时间]

---

#### [条目标题2]
[条目内容]

**标签:** [标签列表]
**创建时间:** [记录创建时间]

---

### [分类名称2]
[其他分类的条目...]

## 统计信息
- 各分类条目统计
- 标签使用频率
- 其他相关统计

*本文档由Claude Code自动生成于 [生成时间]*
```

### 6. 查找Daily Note wiki空间和2025文档

使用 `search-wiki` 工具查找Daily Note wiki空间：
```
工具: search-wiki
参数: {
  "query": "Daily Note"
}
```

从结果中找到 `obj_type` 为 "wiki" 或者其他文档类型的Daily Note空间。

**错误处理：**
- 如果找不到Daily Note wiki空间：停止执行，告知用户"未找到Daily Note wiki空间，请确认：1) 空间名称是否正确 2) 您是否有访问权限 3) 空间是否存在"
- 如果找到多个同名空间：列出所有匹配项，要求用户确认选择哪一个
- 如果空间类型不符合预期：告知用户"找到的Daily Note不是wiki空间，当前类型：[显示实际类型]"

**用户决策点：** 确认正确的wiki空间，或提供准确的空间名称。

### 7. 获取空间节点并查找2025文档

使用 `get-space-nodes` 工具获取空间中的节点：
```
工具: get-space-nodes
参数: {
  "space_id": "[space_id]"
}
```

在节点中查找标题为 "2025" 的文档。如果不存在，使用 `create-wiki-node` 创建：

```
工具: create-wiki-node
参数: {
  "space_id": "[space_id]",
  "obj_type": "docx",
  "title": "2025"
}
```

**错误处理：**
- 如果无法获取空间节点：停止执行，告知用户"无法访问wiki空间节点，错误信息：[具体错误]，请检查对该空间的读取权限"
- 如果创建2025文档失败：停止执行，告知用户"无法创建2025文档，错误信息：[具体错误]，请检查对该空间的编辑权限"
- 如果找到多个2025文档：列出所有匹配项，要求用户确认使用哪一个

**用户决策点：** 确认是否有空间编辑权限，或选择正确的2025文档。

### 8. 创建当日文档

在2025文档下创建以当前日期为标题的新文档：
```
工具: create-wiki-node
参数: {
  "space_id": "[space_id]",
  "obj_type": "docx",
  "title": "{{target_date}}",
  "parent_node_token": "[2025文档的obj_token]"
}
```

**错误处理：**
- 如果创建文档失败：停止执行，告知用户"无法创建日期文档，错误信息：[具体错误]，可能原因：1) 编辑权限不足 2) 同名文档已存在 3) 父文档不存在"
- 如果同名文档已存在：询问用户是否覆盖、创建新版本还是取消操作
- 如果父文档token无效：告知用户"2025文档token无效，请检查文档是否存在或已被删除"

**用户决策点：** 处理同名文档冲突，确认操作方式。

### 9. 转换Markdown为Blocks

使用 `convert-content-to-blocks` 工具将生成的Markdown转换为飞书文档blocks：
```
工具: convert-content-to-blocks
参数: {
  "content_type": "markdown",
  "content": "[步骤5生成的markdown内容]"
}
```

**错误处理：**
- 如果转换失败：停止执行，告知用户"Markdown转换失败，错误信息：[具体错误]，可能原因：1) Markdown格式错误 2) 内容过长 3) 包含不支持的元素"
- 如果转换结果为空：告知用户"转换结果为空，请检查Markdown内容是否正确"

**用户决策点：** 检查并修正Markdown内容格式。

### 10. 保存内容到文档

使用 `create-document-blocks` 工具将blocks保存到新创建的文档：
```
工具: create-document-blocks
参数: {
  "document_id": "[新文档的obj_token]",
  "index": 0,
  "blocks": "[转换后的blocks]"
}
```

**错误处理：**
- 如果保存失败：停止执行，告知用户"保存文档内容失败，错误信息：[具体错误]，可能原因：1) 文档编辑权限不足 2) 文档已被锁定 3) blocks格式错误"
- 如果文档不存在：告知用户"目标文档不存在或已被删除，文档ID：[document_id]"

**用户决策点：** 确认文档权限和状态。

### 11. 输出结果

返回包含以下信息的成功消息：
- 处理的记录数量
- 创建的文档ID和标题
- 文档访问URL: `https://feishu.cn/wiki/[document_token]`
- 父文档信息（2025文档）
- 所属空间信息

## 错误处理

1. **找不到Daily Note多维表格**
   - 提供清晰的错误信息
   - 建议用户检查表格名称是否正确

2. **当日无记录**
   - 仍然创建文档，但内容为"当日无新增记录"
   - 保持文档结构的一致性

3. **权限问题**
   - 检查用户是否有相关空间和表格的访问权限
   - 提供权限获取指导

4. **API调用失败**
   - 重试机制（如适用）
   - 清晰的错误信息反馈

## 最佳实践

1. **字段名称适配**
   - 支持中英文字段名
   - 智能匹配相似字段名

2. **内容格式化**
   - 自动处理特殊字符
   - 保持Markdown格式的美观性

3. **性能优化**
   - 合理设置分页大小
   - 避免一次性处理过多记录

4. **用户体验**
   - 提供处理进度反馈
   - 清晰的成功/失败状态提示