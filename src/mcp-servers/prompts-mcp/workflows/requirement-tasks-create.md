# 需求任务拆解 Workflow

## 概述

这个工作流程用于基于PRD文档和用户理解，将需求拆解为具体的开发任务。该工作流不会执行任务，而是专注于任务的分析和拆解。

## 输入参数

- **用户输入内容** (`inputStr`): 用户对需求的理解和所需的上下文信息等

## 工作流程

### 阶段 1: PRD内容获取

**目标**: 获取需求的PRD文档详细信息作为任务拆解的基础

**执行步骤**:

1. **识别PRD地址**:
   - 从用户输入内容中提取PRD地址
   - 支持的地址格式：
     - Confluence页面URL
     - PRD文档链接
     - 页面ID

2. **获取PRD内容**:
   使用 confluence-mcp 的 `get-wiki-page-content` 工具：
   ```
   工具名称: get-wiki-page-content
   参数:
   - pageId: 从PRD地址中提取的页面ID
   - format: markdown (获取markdown格式便于后续处理)
   ```

3. **内容验证**:
   - 验证是否成功获取PRD内容
   - 检查内容完整性
   - 如果无法获取PRD地址或内容，停止后续流程并提示用户

**失败处理**:
- 如果无法从用户输入中识别PRD地址，询问用户提供具体的PRD链接
- 如果无法访问PRD内容，提示用户检查权限和地址有效性
- 停止后续流程并给出明确的错误说明

---

### 阶段 2: 任务拆解分析

**目标**: 结合用户输入和PRD文档进行详细的任务拆解

**执行步骤**:

1. **需求分析**:
   - 分析PRD文档中的功能需求
   - 识别技术要求和约束条件
   - 结合用户输入的理解和上下文信息

2. **接口文档获取**（如果用户提供了接口文档信息）:
   - 从用户输入中识别接口文档地址（Weapons平台链接）
   - 提取接口ID（从URL中提取，如：https://weapons.xx.com/project/17869/interface/api/1889830 → 1889830）
   - 使用 weapons-mcp 的 `get-endpoint-detail` 工具获取接口详细信息：
     ```
     工具名称: get-endpoint-detail
     参数:
     - id: 从接口文档地址中提取的接口ID
     ```
   - 解析接口详情包括：
     - 接口名称和描述
     - 请求方法和路径
     - 请求参数（header、query、body）
     - 响应格式和字段说明
     - 错误码定义

3. **任务拆解**:
   将需求拆解为具体的开发任务，每个任务包含以下信息：

   ```xml
   <Task>
   <名称>{{task_name}}</名称>
   <描述>{{task_description}}</描述>
   <上下文>
     <变更文件>
     {{涉及的文件路径和变更说明}}
     </变更文件>
     <相关接口>
     {{如果任务涉及接口开发，在此处添加接口详情}}
     </相关接口>
   </上下文>
   <实现步骤>
   {{详细的实现步骤描述}}
   </实现步骤>
   </Task>
   ```

4. **任务特征**:
   - **任务名称**: 简洁明确地描述任务目标
   - **任务描述**: 详细说明该任务需要做什么，包括功能要点和业务目标
   - **变更文件**: 列出需要修改或创建的文件
   - **相关接口**: 如果任务涉及接口开发，包含从weapons-mcp获取的接口详细信息
   - **实现步骤**: 详细的技术实现步骤

5. **任务拆解基本原则**:

   **优先级原则**:
   - 以用户输入的内容为主导，PRD文档信息作为辅助补充
   - 用户明确提及的功能需求必须体现在任务拆解中
   - PRD信息主要用于补充技术细节和实现规范

   **数量对应原则**:
   - 任务数量根据用户输入中的功能点确定
   - 例如：用户输入"实现登录功能和landing page"应拆解为两个独立任务
   - 避免将用户明确分开的功能合并到一个任务中

   **高内聚低耦合原则**:
   - 每个任务内部功能紧密相关，围绕单一职责展开
   - 任务之间依赖关系最小化，支持并行开发
   - 每个任务应该是独立可执行的完整功能单元

   **任务标记原则**:
   - 如果拆解得到的任务未在用户输入中明确体现，需要在任务名称中标记
   - 标记格式：`任务名称 (建议任务，用户可选择是否实现)`
   - 例如：`数据库迁移脚本 (建议任务，用户可选择是否实现)`
   - 确保用户能够识别哪些是额外建议的任务

   **粒度控制原则**:
   - 任务粒度适中，不过于庞大或琐碎
   - 包含足够的上下文信息便于后续独立执行
   - 考虑合理的工作量分配和时间估算

   **测试原则**:
   - 如果用户未明确需要添加测试用例，则不要在任务的实现步骤中添加测试相关的步骤
   - 任务专注于业务功能开发，避免添加用户未要求的测试工作
   - 只有当用户明确提及测试需求时，才在相应任务中包含测试步骤

6. **拆解示例说明**:

   **示例1 - 明确功能对应**:
   ```
   用户输入: "实现登录功能和landing page"
   正确拆解:
   - 任务1: 用户登录功能开发
   - 任务2: Landing页面实现

   说明: 用户明确提及两个功能，应拆解为两个独立任务
   ```

   **示例2 - 建议任务标记**:
   ```
   用户输入: "实现用户注册功能"
   可能拆解:
   - 任务1: 用户注册功能开发 (用户明确要求)
   - 任务2: 邮箱验证功能 (建议任务，用户可选择是否实现)
   - 任务3: 用户行为埋点 (建议任务，用户可选择是否实现)

   说明: 用户只提到注册，邮箱验证和埋点是从PRD推导的建议任务
   ```

   **示例3 - 高内聚拆解**:
   ```
   用户输入: "实现用户管理系统"
   正确拆解:
   - 任务1: 用户注册功能开发
   - 任务2: 用户登录功能开发
   - 任务3: 用户信息管理功能开发

   错误拆解:
   - 任务1: 前端页面开发 (耦合度高，包含多个功能的前端)
   - 任务2: 后端接口开发 (耦合度高，包含多个功能的后端)

   说明: 应按功能模块拆解，而非按技术层次拆解
   ```

**输出格式示例**:
```xml
<Task>
<名称>用户登录接口开发</名称>
<描述>开发用户登录功能的后端API接口，支持用户名/邮箱+密码的认证方式，集成JWT token机制，实现安全的用户身份验证和会话管理</描述>
<上下文>
  <变更文件>
  - src/api/auth.ts: 创建登录接口
  - src/types/user.ts: 定义用户类型
  - src/middleware/auth.ts: 添加认证中间件
  </变更文件>
  <登录接口>
  接口名称: 用户登录
  请求方法: POST
  请求路径: /api/v1/user/login
  请求参数:
    - username (string, required): 用户名
    - password (string, required): 密码
    - remember (boolean, optional): 是否记住登录状态
  响应格式:
    - code (number): 状态码，200表示成功
    - message (string): 响应消息
    - data.token (string): JWT访问令牌
    - data.user (object): 用户基本信息
  错误码:
    - 1001: 用户名或密码错误
    - 1002: 账户被锁定
    - 1003: 验证码错误
  </登录接口>
</上下文>
<实现步骤>
1. 在 src/api/auth.ts 中创建 POST /api/v1/user/login 接口
2. 实现用户名密码验证逻辑，支持用户名和邮箱登录
3. 集成JWT token生成功能，设置合适的过期时间
4. 添加登录失败重试限制，防止暴力破解
5. 实现记住登录状态功能
6. 按照接口文档返回标准格式的响应数据
7. 处理各种错误情况，返回对应的错误码
</实现步骤>
</Task>

<Task>
<名称>前端登录页面实现</名称>
<描述>创建用户登录的前端页面和交互逻辑，包括登录表单、输入验证、API调用、状态管理和用户体验优化，为用户提供友好的登录界面</描述>
<上下文>
  <变更文件>
  - src/pages/Login.tsx: 创建登录页面组件
  - src/components/LoginForm.tsx: 登录表单组件
  - src/hooks/useAuth.ts: 认证状态管理Hook
  - src/styles/login.css: 登录页面样式
  </变更文件>
  <相关接口>
  调用登录接口: POST /api/v1/user/login
  </相关接口>
</上下文>
<实现步骤>
1. 创建响应式登录页面布局
2. 实现表单验证（用户名、密码格式验证）
3. 集成登录API调用，对接后端登录接口
4. 添加加载状态和错误提示，处理各种错误码
5. 实现记住登录状态功能
6. 添加页面跳转逻辑
7. 处理JWT token存储和状态管理
</实现步骤>
</Task>

<Task>
<名称>用户行为分析埋点 (建议任务，用户可选择是否实现)</名称>
<描述>为登录功能添加用户行为分析埋点，收集登录成功率、失败原因等关键指标，用于后续产品优化和用户体验改进</描述>
<上下文>
  <变更文件>
  - src/utils/analytics.ts: 创建埋点工具函数
  - src/pages/Login.tsx: 集成登录相关埋点
  - src/hooks/useAuth.ts: 添加认证状态埋点
  </变更文件>
  <相关接口>
  调用埋点上报接口: POST /api/analytics/track
  </相关接口>
</上下文>
<实现步骤>
1. 创建通用的埋点上报工具函数
2. 在登录页面添加页面访问埋点
3. 添加登录尝试、成功、失败等关键节点埋点
4. 记录登录方式（用户名/邮箱）和设备信息
5. 实现埋点数据的本地缓存和批量上报
6. 添加埋点开关，支持隐私模式
</实现步骤>
</Task>
```

---

### 阶段 3: 用户确认与补充

**目标**: 与用户确认拆解结果，收集补充信息完善任务定义

**执行步骤**:

1. **展示拆解结果**:
   - 以清晰的格式展示所有拆解的任务
   - 突出显示每个任务的关键信息
   - 说明任务之间的关系和依赖

2. **询问用户补充**:
   针对每个任务询问用户是否需要补充：

   **上下文信息补充**:
   - "是否有其他需要修改的文件？"
   - "是否有特定的技术栈或工具要求？"
   - "是否有现有代码需要考虑兼容性？"

   **实现步骤完善**:
   - "实现步骤是否足够详细？"
   - "是否有遗漏的关键步骤？"
   - "是否需要特殊的错误处理或边界情况考虑？"

   **其他补充**:
   - "是否有测试要求？"
   - "是否有性能或安全方面的特殊要求？"
   - "是否需要文档更新？"
   - "接口信息是否完整准确？"（如果涉及接口开发）

3. **迭代完善**:
   - 根据用户反馈更新任务定义
   - 重新生成完善后的任务XML
   - 确认用户满意后结束流程

4. **最终确认**:
   询问用户：
   - "以上任务拆解是否完整？"
   - "是否还有其他需要补充的任务或信息？"
   - "任务的优先级和依赖关系是否清晰？"

**输出**: 经用户确认和完善的最终任务列表，格式为完整的XML任务定义

---

## 使用示例

### 输入示例
```
用户输入: "我需要实现一个用户管理系统，包括用户注册、登录、个人信息管理等功能。
PRD地址: https://confluence.company.com/pages/123456
登录接口文档: https://weapons.xx.com/project/17869/interface/api/1889830
注册接口文档: https://weapons.xx.com/project/17869/interface/api/1889831"
```

### 输出示例
经过完整流程后，将得到如下格式的任务列表：

```xml
<Task>
<名称>用户注册功能开发</名称>
<描述>开发用户注册功能的后端API，包括用户信息验证、数据存储、邮箱唯一性检查等核心功能，为新用户提供安全可靠的账户创建服务</描述>
<上下文>
  <变更文件>
  - src/api/user.ts: 创建用户注册接口
  - src/validators/user.ts: 用户信息验证规则
  - src/models/User.ts: 用户数据模型
  - database/migrations/001_create_users_table.sql: 数据库表创建
  </变更文件>
  <注册接口>
  接口名称: 用户注册
  请求方法: POST
  请求路径: /api/v1/user/register
  请求参数:
    - username (string, required): 用户名，3-20个字符
    - email (string, required): 邮箱地址
    - password (string, required): 密码，6-20个字符
    - confirmPassword (string, required): 确认密码
  响应格式:
    - code (number): 状态码，200表示成功
    - message (string): 响应消息
    - data.userId (string): 用户ID
    - data.email (string): 用户邮箱
  错误码:
    - 2001: 用户名已存在
    - 2002: 邮箱已被注册
    - 2003: 密码格式不正确
    - 2004: 两次密码不一致
  </注册接口>
</上下文>
<实现步骤>
1. 设计用户数据库表结构（用户名、邮箱、密码等字段）
2. 创建用户注册API接口 POST /api/v1/user/register
3. 实现用户名和邮箱唯一性验证
4. 添加密码格式验证和加密存储
5. 实现密码确认验证逻辑
6. 按照接口文档返回标准格式的响应数据
7. 处理各种错误情况，返回对应的错误码
8. 实现邮箱验证功能（可选）
</实现步骤>
</Task>

<Task>
<名称>用户登录功能开发</名称>
<描述>实现用户登录认证系统，包括密码验证、JWT token生成、会话管理和安全防护机制，为用户提供安全可靠的身份认证服务</描述>
<上下文>
  <变更文件>
  - src/api/auth.ts: 登录认证接口
  - src/middleware/auth.ts: JWT认证中间件
  - src/services/tokenService.ts: Token管理服务
  </变更文件>
</上下文>
<实现步骤>
1. 创建登录接口 POST /api/login
2. 实现用户名/邮箱密码验证
3. 集成JWT token生成和管理
4. 添加登录失败限制机制
5. 实现token刷新功能
6. 编写认证中间件
</实现步骤>
</Task>
```

## 注意事项

1. **PRD依赖性**: 必须能够获取到PRD内容才能继续，否则无法进行有效的任务拆解
2. **任务粒度**: 保持任务粒度的合理性，既不过于宏观也不过于细节
3. **上下文完整性**: 确保每个任务都有足够的上下文信息支持独立执行
4. **用户参与**: 重视用户的补充和确认，确保拆解结果符合实际需求
5. **格式规范**: 严格遵循XML格式输出，便于后续工具处理