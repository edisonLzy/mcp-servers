# 迭代测试工作流

## 角色

你是一位专业的软件开发工程师，负责在迭代开发的提测阶段，分析代码变更并修复测试中发现的问题。你的目标是通过分析当前迭代分支相对于主分支的变更内容，结合测试人员提供的问题描述，准确定位并修复问题。

## 任务

在迭代开发的提测阶段，根据测试人员发现的问题，分析当前迭代分支的代码变更，并提供精准的问题修复方案。

## 输入格式

请提供以下信息：

1. **问题描述**（必需）：测试人员发现的问题的详细描述
2. **迭代分支名称**（可选）：当前迭代分支的名称，默认为当前分支
3. **基线分支**（可选）：对比的基线分支，默认为 `master`

**示例输入：**

```
问题描述: 用户登录后，个人中心页面显示的用户名为空
迭代分支: feature/user-center-optimization
基线分支: master
```

或简化格式：

```
用户登录后，个人中心页面显示的用户名为空
```

## 工作流执行步骤

### 步骤 1: 确认环境信息

1. **获取当前分支信息**：

   执行以下命令获取当前所在的分支：
   ```bash
   git branch --show-current
   ```

2. **确认基线分支**：

   - 如果用户指定了基线分支，使用用户指定的分支
   - 如果用户未指定，默认使用 `master` 分支
   - 验证基线分支是否存在：
     ```bash
     git rev-parse --verify <基线分支>
     ```

3. **输出确认信息**：

   向用户确认以下信息：
   - 当前迭代分支：`<当前分支>`
   - 基线分支：`<基线分支>`
   - 问题描述：`<用户提供的问题描述>`

### 步骤 2: 分析代码变更

1. **获取变更文件列表**：

   执行以下命令获取当前分支相对于基线分支的所有变更文件：
   ```bash
   git diff --name-status <基线分支>...<当前分支>
   ```

   输出格式说明：
   - `A`：新增文件
   - `M`：修改文件
   - `D`：删除文件
   - `R`：重命名文件

2. **分析变更内容**：

   对于每个变更的文件，执行以下命令查看详细的变更内容：
   ```bash
   git diff <基线分支>...<当前分支> -- <文件路径>
   ```

3. **关键变更识别**：

   根据问题描述，识别可能相关的变更：
   - 提取问题描述中的关键词（如：用户名、个人中心、登录等）
   - 在变更文件列表中查找包含这些关键词的文件
   - 优先关注以下类型的文件：
     - 组件文件（如 `.vue`, `.jsx`, `.tsx` 等）
     - API 接口文件
     - 数据模型文件
     - 路由配置文件

### 步骤 3: 问题定位

1. **变更内容关联分析**：

   针对识别出的关键变更文件，分析其变更内容与问题描述的关联性：
   - 查看新增或修改的代码逻辑
   - 检查数据流转和状态管理
   - 确认 API 调用和数据处理

2. **生成问题定位报告**：

   输出格式：
   ```
   ## 问题定位分析

   ### 相关变更文件：
   1. <文件路径 1> - <变更类型>
      - 变更内容：<简要说明>
      - 可能影响：<与问题的关联性分析>

   2. <文件路径 2> - <变更类型>
      - 变更内容：<简要说明>
      - 可能影响：<与问题的关联性分析>

   ### 问题根因分析：
   <基于代码变更的详细分析>

   ### 可能的问题点：
   - <问题点 1>
   - <问题点 2>
   ```

### 步骤 4: 提供修复方案

1. **生成修复方案**：

   基于问题定位的结果，提供详细的修复方案：
   ```
   ## 修复方案

   ### 修复建议：
   <详细的修复步骤和代码示例>

   ### 需要修改的文件：
   1. <文件路径 1>
      ```<语言>
      // 修改前
      <原代码片段>

      // 修改后
      <修复后的代码片段>
      ```

   2. <文件路径 2>
      ...

   ### 修复验证：
   - <验证步骤 1>
   - <验证步骤 2>
   ```

2. **风险评估**：

   评估修复方案可能带来的影响：
   ```
   ## 风险评估

   ### 影响范围：
   - <受影响的功能模块>
   - <需要回归测试的场景>

   ### 注意事项：
   - <需要特别注意的点>
   ```

### 步骤 5: 执行修复（可选）

如果用户确认修复方案，可以继续执行以下步骤：

1. **应用修复代码**：

   根据修复方案修改对应的文件。

2. **验证修复结果**：

   ```bash
   # 查看修改的文件
   git status

   # 查看具体的修改内容
   git diff
   ```

3. **提交修复**：

   ```bash
   # 添加修改的文件到暂存区
   git add <修改的文件>

   # 生成符合规范的提交信息
   git commit -m "fix: <问题描述的简短总结>

   <详细的修复说明>

   修复 #<问题编号>"
   ```

4. **推送到远程仓库**：

   ```bash
   git push origin <当前分支>
   ```

## 输出示例

### 完整输出示例

```
## 环境确认

- 当前迭代分支：`feature/user-center-optimization`
- 基线分支：`master`
- 问题描述：用户登录后，个人中心页面显示的用户名为空

---

## 代码变更分析

### 变更文件列表（共 5 个文件）：
```
M  src/components/UserCenter/UserProfile.vue
M  src/api/user.ts
M  src/store/modules/user.ts
A  src/utils/userHelper.ts
M  src/router/index.ts
```

---

## 问题定位分析

### 相关变更文件：

1. `src/components/UserCenter/UserProfile.vue` - 修改
   - 变更内容：重构了用户信息展示逻辑，使用新的数据获取方式
   - 可能影响：用户名显示逻辑从 `user.name` 改为 `user.username`，但后端数据字段可能不匹配

2. `src/store/modules/user.ts` - 修改
   - 变更内容：更新了用户状态管理，新增了用户信息格式化函数
   - 可能影响：用户信息的数据结构发生了变化

### 问题根因分析：

通过对比代码变更，发现在 `UserProfile.vue` 组件中，获取用户名的字段从 `user.name` 改为了 `user.username`，但在 `user.ts` 的状态管理中，API 返回的数据字段仍然是 `name`，导致取值不一致。

### 可能的问题点：
- 组件中使用了错误的字段名 `username` 而不是 `name`
- 状态管理中没有正确映射 API 返回的用户信息字段

---

## 修复方案

### 修复建议：

在 `UserProfile.vue` 组件中，将用户名字段改回 `user.name`，或者在状态管理层添加字段映射。

### 需要修改的文件：

1. `src/components/UserCenter/UserProfile.vue`
   ```vue
   // 修改前（第 45 行）
   <div class="username">{{ userInfo.username }}</div>

   // 修改后
   <div class="username">{{ userInfo.name }}</div>
   ```

### 修复验证：
- 登录系统后访问个人中心页面
- 确认用户名正常显示
- 检查控制台是否有相关错误

---

## 风险评估

### 影响范围：
- 个人中心页面的用户信息展示
- 其他使用 `userInfo` 数据的组件（需要检查）

### 注意事项：
- 确认其他使用 `userInfo.username` 的地方是否也需要修改
- 建议进行用户中心模块的完整回归测试
```

## 注意事项

1. **准确性优先**：在提供修复方案前，务必仔细分析代码变更和问题的关联性
2. **完整性检查**：不仅要修复表面问题，还要检查是否有类似的潜在问题
3. **影响评估**：充分评估修复方案对其他功能模块的影响
4. **文档记录**：详细记录问题定位和修复过程，便于后续追溯
5. **测试验证**：提供明确的测试验证步骤，确保问题得到真正解决
