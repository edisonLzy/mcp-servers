 # 聊天记录查询优化功能清单

## 背景概述
根据需求文档，当前系统在房源维护详情页和线索详情页的聊天记录查询存在逻辑问题，导致：
1. 质检不通过产生大量申诉单
2. 云管家需要手动提供申诉凭证
3. 某些业主尽管已加微信，但无法正确显示聊天记录

## 房源维护详情页优化

### 聊天记录查询逻辑更新
- [ ] 修改聊天记录查询逻辑
  - [ ] 当房源有绑定业主时，使用业主unionId调用加微关系接口获取加微关系
  - [ ] 当房源没有绑定业主时，使用房源挂牌手机号码调用加微关系接口获取加微关系

### 聊天记录弹窗功能优化
- [ ] 更新聊天记录弹窗展示逻辑
  - [ ] 展示与业主手机号最近一次加微关系的企微号与业主微信的对话记录
  - [ ] 默认展示最近50条聊天记录
  - [ ] 实现"查看历史对话"功能，支持向前加载更多50条记录，直到没有更多历史记录
  - [ ] 设置弹窗名称为"{接线客服账号}与{业主微信昵称}的聊天记录"
  - [ ] 当无聊天记录数据时，弹窗内显示"暂无记录"

### 私域服务记录判断逻辑更新
- [ ] 更新私域服务记录是否加微的判断逻辑
  - [ ] 将判断逻辑更新为与聊天记录查询相同的逻辑

## 线索详情页优化

### 修复数据来源问题
- [ ] 更新手机号码获取逻辑
  - [ ] 将线索关联的手机号码获取来源从线索主表更改为线索预录入表

### 聊天记录查询逻辑更新
- [ ] 使用更新后的手机号码获取逻辑调用加微关系接口
  - [ ] 确保使用正确的手机号码获取加微关系

### 聊天记录弹窗功能优化
- [ ] 实现与房源维护详情页相同的聊天记录展示功能
  - [ ] 展示与业主手机号最近一次加微关系的企微号与业主微信的对话记录
  - [ ] 默认展示最近50条聊天记录
  - [ ] 实现"查看历史对话"功能，支持向前加载更多50条记录，直到没有更多历史记录
  - [ ] 设置弹窗名称为"{接线客服账号}与{业主微信昵称}的聊天记录"
  - [ ] 当无聊天记录数据时，弹窗内显示"暂无记录"